{{- include "oc.basicServiceTemplates" (dict "scope" . "appName" "appNameOpenldap" "appNameSuffix" "") -}}
{{- $openldap := .Values.services.openldap }}
{{- $useCertManager := and $openldap.tls.certManager.enabled }}
{{- $certSecret := include "secrets.ldapCertSecret" . }}
{{- $caSecret := include "secrets.ldapCASecret" . }}
{{- $useCA := or (not $useCertManager) .Values.secretRefs.ldapCaRef }}
{{- if and $openldap.enabled .Values.features.externalUserManagement.enabled }}
apiVersion: apps/v1
kind: Deployment
{{ include "oc.metadata" . }}
spec:
  {{- include "oc.selector" . | nindent 2 }}
  replicas: 1
  strategy:
    type: Recreate
  template:
    {{- include "oc.templateMetadata" (dict "scope" $ "configCheck" false) | nindent 4 }}
    spec:
      {{- include "oc.affinity" $ | nindent 6 }}
      {{- include "oc.priorityClassName" $.priorityClassName | nindent 6 }}
      {{- include "oc.hostAliases" $ | nindent 6 }}
      nodeSelector: {{ toYaml $.nodeSelector | nindent 8 }}
      {{- with $openldap.podSecurityContext }}
      securityContext:
{{ toYaml . | nindent 8 }}
      {{- end }}
      {{- if $openldap.persistence.enabled }}
      initContainers:
        - name: init-openldap-dirs
          {{- include "oc.initContainerImage" $ | nindent 10 }}
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              mkdir -p /data/data /data/config
          volumeMounts:
            - name: data
              mountPath: /data
      {{- end }}
      containers:
        - name: {{ .appName }}
          image: "{{ ($openldap.image.registry | default "docker.io") }}/{{ ($openldap.image.repository | default "osixia/openldap") }}:{{ ($openldap.image.tag | default "1.5.0") }}"
          imagePullPolicy: {{ $openldap.image.pullPolicy | default "IfNotPresent" }}
          {{- with $openldap.securityContext }}
          securityContext:
{{- toYaml . | nindent 12 }}
          {{- end }}
          env:
            - name: LDAP_ORGANISATION
              value: {{ $openldap.organisation | quote }}
            - name: LDAP_DOMAIN
              value: {{ $openldap.domain | quote }}
            - name: LDAP_BASE_DN
              value: {{ include "oc.ldapBaseDN" . | quote }}
            - name: LDAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "secrets.ldapBindSecret" . }}
                  key: reva-ldap-bind-password
            - name: LDAP_CONFIG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "secrets.ldapBindSecret" . }}
                  key: reva-ldap-bind-password
            - name: LDAP_READONLY_USER
              value: "false"
            - name: LDAP_TLS
              value: "true"
            - name: LDAP_TLS_CRT_FILENAME
              value: ldap.crt
            - name: LDAP_TLS_KEY_FILENAME
              value: ldap.key
            {{- if $useCA }}
            - name: LDAP_TLS_CA_CRT_FILENAME
              value: ldap-ca.crt
            {{- end }}
            - name: LDAP_TLS_ENFORCE
              value: "true"
            - name: LDAP_TLS_VERIFY_CLIENT
              value: "allow"
          ports:
            - name: ldap
              containerPort: {{ $openldap.ports.ldap | default 389 }}
            - name: ldaps
              containerPort: {{ $openldap.ports.ldaps | default 636 }}
          volumeMounts:
            - name: bootstrap
              mountPath: /container/service/slapd/assets/config/bootstrap/ldif/custom/10_base.ldif
              subPath: 10_base.ldif
              readOnly: true
            - name: bootstrap
              mountPath: /container/service/slapd/assets/config/bootstrap/schema/custom/10_opencloud_schema.ldif
              subPath: 10_opencloud_schema.ldif
              readOnly: true
            - name: data
              mountPath: {{ $openldap.persistence.dataPath | default "/var/lib/ldap" | quote }}
              subPath: data
            - name: data
              mountPath: {{ $openldap.persistence.configPath | default "/etc/ldap/slapd.d" | quote }}
              subPath: config
            - name: ldap-certs
              mountPath: /container/service/slapd/assets/certs
              readOnly: true
          resources:
            {{- toYaml .resources | nindent 12 }}
      {{- include "oc.imagePullSecrets" $ | nindent 6 }}
      volumes:
        - name: bootstrap
          configMap:
            name: {{ .appName }}-config
        - name: ldap-certs
          projected:
            sources:
              - secret:
                  name: {{ $certSecret }}
                  items:
                    - key: {{ ternary "tls.crt" "ldap.crt" $useCertManager }}
                      path: ldap.crt
                    - key: {{ ternary "tls.key" "ldap.key" $useCertManager }}
                      path: ldap.key
              {{- if $useCA }}
              - secret:
                  name: {{ $caSecret }}
                  items:
                    - key: {{ ternary "ca.crt" "ldap-ca.crt" $useCertManager }}
                      path: ldap-ca.crt
                  optional: false
              {{- end }}
        - name: data
          {{- if $openldap.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .appName }}-data
          {{- else }}
          emptyDir: {}
          {{- end }}
{{- end }}
